name: Auto Update Python Config

on:
  # å®šæ—¶æ£€æŸ¥ï¼šæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆé…ç½®'
        required: false
        default: false
        type: boolean
  
  # æ¨é€è§¦å‘ï¼šå½“pyç›®å½•æœ‰å˜åŒ–æ—¶
  push:
    paths:
      - 'py/**'
      - 'update_py_config.py'
      - '.github/workflows/auto_update_py_config.yml'

jobs:
  update-config:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆä½¿ç”¨å®Œæ•´å†å²ï¼‰
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # 2. è®¾ç½®Pythonç¯å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. æ£€æŸ¥æ–‡ä»¶å˜åŒ–å¹¶æ›´æ–°é…ç½®
    - name: Check and Update Config
      id: update-config
      run: |
        echo "ğŸš€ å¼€å§‹æ™ºèƒ½é…ç½®æ›´æ–°..."
        echo "å·¥ä½œç›®å½•: $(pwd)"
        
        # æ˜¾ç¤ºå½“å‰pyç›®å½•çŠ¶æ€
        if [ -d "py" ]; then
          echo "ğŸ“ pyç›®å½•å†…å®¹:"
          ls -la py/ || echo "pyç›®å½•ä¸ºç©º"
        else
          echo "ğŸ“ åˆ›å»ºpyç›®å½•..."
          mkdir -p py
        fi
        
        # æ£€æŸ¥çŠ¶æ€æ–‡ä»¶
        if [ -f "py_state.json" ]; then
          echo "ğŸ“Š å½“å‰çŠ¶æ€æ–‡ä»¶:"
          python3 -c "import json; data=json.load(open('py_state.json')); print(f'å·²è®°å½• {len(data)} ä¸ªæ–‡ä»¶')"
        fi
        
        # è¿è¡Œæ›´æ–°è„šæœ¬
        echo "ğŸ”„ è¿è¡Œæ›´æ–°è„šæœ¬..."
        
        FORCE_FLAG=""
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          FORCE_FLAG="--force"
          echo "ğŸ”§ å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ¨¡å¼"
        fi
        
        python update_py_config.py $FORCE_FLAG
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ–°é…ç½®
        if [ -f "configs/plugins.json" ]; then
          echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
          echo "ğŸ“„ é…ç½®æ–‡ä»¶é¢„è§ˆ:"
          head -20 configs/plugins.json
          
          # éªŒè¯JSONæ ¼å¼
          if python3 -m json.tool configs/plugins.json > /dev/null 2>&1; then
            echo "âœ… JSONæ ¼å¼æ­£ç¡®"
          else
            echo "âŒ JSONæ ¼å¼é”™è¯¯"
            exit 1
          fi
        else
          echo "â„¹ï¸  æœªç”Ÿæˆæ–°é…ç½®æ–‡ä»¶ï¼ˆå¯èƒ½æ²¡æœ‰å˜åŒ–ï¼‰"
        fi
    
    # 4. é…ç½®Git
    - name: Configure Git
      if: steps.update-config.outcome == 'success'
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
    
    # 5. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
    - name: Check for changes to commit
      id: check-changes
      if: steps.update-config.outcome == 'success'
      run: |
        echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        
        # æ·»åŠ æ‰€æœ‰å¯èƒ½å˜æ›´çš„æ–‡ä»¶
        git add configs/ plugins.json py_state.json update_py_config.py
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
        if ! git diff --cached --quiet; then
          echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤"
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          echo "å˜æ›´æ‘˜è¦:"
          git diff --cached --stat
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    # 6. æäº¤å˜æ›´
    - name: Commit changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "ğŸ“ æäº¤å˜æ›´..."
        
        COMMIT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
        COMMIT_MSG="ğŸ¤– è‡ªåŠ¨æ›´æ–°: Pythoné…ç½® [$COMMIT_DATE]"
        
        git commit -m "$COMMIT_MSG"
        
        # æ˜¾ç¤ºæäº¤å†å²
        echo "ğŸ“œ æœ€è¿‘æäº¤:"
        git log --oneline -3
    
    # 7. æ¨é€å˜æ›´ï¼ˆä½¿ç”¨å®‰å…¨æ¨é€ï¼‰
    - name: Push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "ğŸš€ æ¨é€å˜æ›´..."
        
        # å…ˆæ‹‰å–æœ€æ–°ä»£ç ï¼Œé¿å…å†²çª
        echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
        git pull origin ${{ github.ref_name }} --rebase --autostash || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ¨é€"
        
        # å®‰å…¨æ¨é€
        if git push origin HEAD:${{ github.ref_name }} --force-with-lease; then
          echo "âœ… æ¨é€æˆåŠŸ"
        else
          echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå°è¯•æ ‡å‡†æ¨é€..."
          git push origin HEAD:${{ github.ref_name }}
        fi
    
    # 8. ç”ŸæˆæŠ¥å‘Š
    - name: Generate report
      if: always()
      run: |
        echo "=" * 50
        echo "å·¥ä½œæµæ‰§è¡ŒæŠ¥å‘Š"
        echo "=" * 50
        
        echo "ğŸ“… è¿è¡Œæ—¶é—´: $(date)"
        echo "ğŸ”„ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        
        if [ -f "configs/plugins.json" ]; then
          echo "ğŸ“Š é…ç½®çŠ¶æ€:"
          python3 << 'EOF'
import json, os
try:
    with open('configs/plugins.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    print(f"  é…ç½®é¡¹æ•°é‡: {len(data)}")
    
    # æ£€æŸ¥æ ¼å¼
    if isinstance(data, list) and data:
        first_item = data[0]
        if isinstance(first_item, dict):
            print(f"  ç¬¬ä¸€ä¸ªé…ç½®: {first_item.get('name', 'æœªå‘½å')}")
except Exception as e:
    print(f"  è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
EOF
        fi
        
        if [ -f "py_state.json" ]; then
          echo "ğŸ“ æ–‡ä»¶ç›‘æ§çŠ¶æ€:"
          python3 -c "import json; data=json.load(open('py_state.json')); print(f'  ç›‘æ§æ–‡ä»¶æ•°: {len(data)}')"
        fi
        
        echo "=" * 50
