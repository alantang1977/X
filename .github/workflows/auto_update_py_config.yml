name: Auto Update Python Config

on:
  # 1. å®šæ—¶æ£€æŸ¥ï¼šæ¯å¤©UTC 0ç‚¹å’Œ12ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 0,12 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆé…ç½®'
        required: false
        default: false
        type: boolean
  
  # 3. æ¨é€è§¦å‘ï¼šå½“pyç›®å½•æˆ–è„šæœ¬æœ‰å˜åŒ–æ—¶
  push:
    paths:
      - 'py/**'
      - 'update_py_config.py'
      - '.github/workflows/auto_update_py_config.yml'

# å·¥ä½œæµæƒé™
permissions:
  contents: write
  actions: read

jobs:
  smart-update:
    # ä½¿ç”¨æ˜ç¡®çš„è¿è¡Œå™¨æ ‡ç­¾
    runs-on: ubuntu-22.04
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´
    timeout-minutes: 10
    
    # æ­¥éª¤å®šä¹‰
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ Setup Python
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # 3. éªŒè¯å·¥ä½œæµç¯å¢ƒ
      - name: ğŸ” Verify workflow environment
        id: verify-env
        run: |
          echo "=== ç¯å¢ƒéªŒè¯å¼€å§‹ ==="
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "Pythonç‰ˆæœ¬: $(python --version)"
          echo "ç›®å½•ç»“æ„:"
          ls -la
          
          # æ£€æŸ¥å¿…è¦ç›®å½•
          mkdir -p py configs
          
          echo "=== ç¯å¢ƒéªŒè¯å®Œæˆ ==="
      
      # 4. è¿è¡Œæ™ºèƒ½é…ç½®æ›´æ–°
      - name: ğŸ”§ Run smart config update
        id: run-update
        run: |
          echo "=== æ™ºèƒ½é…ç½®æ›´æ–°å¼€å§‹ ==="
          
          # è®¾ç½®å¼ºåˆ¶æ›´æ–°æ ‡å¿—
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            FORCE_FLAG="--force"
            echo "âš ï¸ å¼ºåˆ¶æ›´æ–°æ¨¡å¼å¯ç”¨"
          fi
          
          # è¿è¡Œæ›´æ–°è„šæœ¬
          if python update_py_config.py $FORCE_FLAG; then
            echo "âœ… æ›´æ–°è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            
            # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†é…ç½®æ–‡ä»¶
            if [ -f "configs/plugins.json" ]; then
              echo "ğŸ“„ é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
              
              # éªŒè¯JSONæ ¼å¼
              if python -m json.tool configs/plugins.json > /dev/null 2>&1; then
                echo "âœ… JSONæ ¼å¼éªŒè¯é€šè¿‡"
                
                # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                FILE_SIZE=$(wc -l < configs/plugins.json)
                echo "ğŸ“Š æ–‡ä»¶è¡Œæ•°: $FILE_SIZE"
                
                # è®¾ç½®è¾“å‡º
                echo "config_generated=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ JSONæ ¼å¼éªŒè¯å¤±è´¥"
                echo "config_generated=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "â„¹ï¸ æœªç”Ÿæˆæ–°é…ç½®æ–‡ä»¶ï¼ˆå¯èƒ½æ²¡æœ‰å˜åŒ–ï¼‰"
              echo "config_generated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ æ›´æ–°è„šæœ¬æ‰§è¡Œå¤±è´¥"
            echo "config_generated=false" >> $GITHUB_OUTPUT
          fi
          
          echo "=== æ™ºèƒ½é…ç½®æ›´æ–°å®Œæˆ ==="
      
      # 5. é…ç½®Gitï¼ˆä¸ºåç»­æäº¤åšå‡†å¤‡ï¼‰
      - name: âš™ï¸ Configure Git
        id: configure-git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false
          
          # è®¾ç½®è¿œç¨‹URL
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          
          echo "âœ… Gité…ç½®å®Œæˆ"
      
      # 6. æ‹‰å–æœ€æ–°ä»£ç ï¼ˆé¿å…å†²çªï¼‰
      - name: ğŸ”„ Pull latest changes
        id: pull-changes
        run: |
          echo "æ­£åœ¨æ‹‰å–æœ€æ–°ä»£ç ..."
          
          # æš‚å­˜å½“å‰æ›´æ”¹
          git stash push -m "auto-update-stash-$(date +%s)" || echo "æ²¡æœ‰å¯æš‚å­˜çš„æ›´æ”¹"
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git pull origin ${{ github.ref_name }} --no-rebase || echo "æ‹‰å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œ"
          
          # æ¢å¤æš‚å­˜çš„æ›´æ”¹
          git stash pop || echo "æ²¡æœ‰æš‚å­˜çš„æ›´æ”¹éœ€è¦æ¢å¤"
          
          echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
      
      # 7. æ£€æŸ¥æ–‡ä»¶å˜æ›´
      - name: ğŸ“ Check for file changes
        id: check-changes
        run: |
          echo "=== æ£€æŸ¥æ–‡ä»¶å˜æ›´ ==="
          
          # æ·»åŠ å¯èƒ½å˜æ›´çš„æ–‡ä»¶
          git add configs/ py_state.json update_py_config.py || echo "æ²¡æœ‰æ–‡ä»¶å¯æ·»åŠ "
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
          if ! git diff --cached --quiet; then
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            
            # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
            echo "å˜æ›´æ‘˜è¦:"
            git diff --cached --stat
            
            # è®¾ç½®è¾“å‡º
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changes_count=$(git diff --cached --numstat | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changes_count=0" >> $GITHUB_OUTPUT
          fi
          
          echo "=== æ£€æŸ¥å®Œæˆ ==="
      
      # 8. æäº¤å˜æ›´ï¼ˆåªåœ¨æœ‰å˜æ›´æ—¶ï¼‰
      - name: ğŸ’¾ Commit changes
        id: commit-changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "=== æäº¤å˜æ›´å¼€å§‹ ==="
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          COMMIT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          COMMIT_MSG="ğŸ¤– Auto Update: Python Config [$COMMIT_DATE]"
          
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            COMMIT_MSG="ğŸ”§ $COMMIT_MSG (Forced)"
          fi
          
          # æäº¤å˜æ›´
          git commit -m "$COMMIT_MSG"
          
          # æ˜¾ç¤ºæäº¤ä¿¡æ¯
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          echo "å˜æ›´æ–‡ä»¶æ•°: ${{ steps.check-changes.outputs.changes_count }}"
          
          echo "=== æäº¤å˜æ›´å®Œæˆ ==="
      
      # 9. æ¨é€å˜æ›´
      - name: ğŸš€ Push changes
        id: push-changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "=== æ¨é€å˜æ›´å¼€å§‹ ==="
          
          # å°è¯•æ¨é€å˜æ›´
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "æ¨é€å°è¯• #$((RETRY_COUNT + 1))"
            
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
                
                # æ‹‰å–æœ€æ–°ä»£ç 
                git pull origin ${{ github.ref_name }} --rebase || echo "æ‹‰å–å¤±è´¥"
              else
                echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
            fi
          done
          
          echo "=== æ¨é€å˜æ›´å®Œæˆ ==="
      
      # 10. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
      - name: ğŸ“Š Generate workflow report
        id: generate-report
        if: always()
        run: |
          echo "========================================="
          echo "         å·¥ä½œæµæ‰§è¡ŒæŠ¥å‘Š"
          echo "========================================="
          echo ""
          echo "ğŸ“… è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${{ github.ref_name }}"
          echo ""
          
          # é…ç½®æ–‡ä»¶çŠ¶æ€
          if [ -f "configs/plugins.json" ]; then
            echo "ğŸ“ é…ç½®æ–‡ä»¶çŠ¶æ€:"
            echo "  è·¯å¾„: configs/plugins.json"
            
            if command -v python3 > /dev/null 2>&1; then
              python3 << 'EOF'
import json, os
try:
    with open('configs/plugins.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    if isinstance(data, list):
        print(f"  é…ç½®é¡¹æ•°é‡: {len(data)}")
        
        if data:
            # æ˜¾ç¤ºéƒ¨åˆ†é…ç½®
            print(f"  ç¤ºä¾‹é…ç½®:")
            for i, item in enumerate(data[:3]):
                name = item.get('name', 'æœªå‘½å')
                api = item.get('api', '')
                print(f"    {i+1}. {name}")
            
            if len(data) > 3:
                print(f"    ... è¿˜æœ‰ {len(data)-3} ä¸ªé…ç½®é¡¹")
    else:
        print(f"  é…ç½®æ ¼å¼é”™è¯¯: ä¸æ˜¯æ•°ç»„")
except Exception as e:
    print(f"  è¯»å–å¤±è´¥: {e}")
EOF
            fi
          else
            echo "ğŸ“ é…ç½®æ–‡ä»¶: æœªç”Ÿæˆ"
          fi
          
          echo ""
          echo "ğŸ“Š å˜æ›´çŠ¶æ€:"
          echo "  æ£€æµ‹åˆ°å˜æ›´: ${{ steps.check-changes.outputs.has_changes || 'false' }}"
          echo "  å˜æ›´æ–‡ä»¶æ•°: ${{ steps.check-changes.outputs.changes_count || 0 }}"
          
          echo ""
          echo "ğŸš€ æ¨é€çŠ¶æ€:"
          if [ "${{ steps.check-changes.outputs.has_changes }}" = "true" ]; then
            if [ "${{ steps.push-changes.conclusion || 'skipped' }}" = "success" ]; then
              echo "  âœ… æ¨é€æˆåŠŸ"
            else
              echo "  âŒ æ¨é€å¤±è´¥æˆ–è·³è¿‡"
            fi
          else
            echo "  â­ï¸  æ— éœ€æ¨é€ï¼ˆæ— å˜æ›´ï¼‰"
          fi
          
          echo ""
          echo "========================================="
