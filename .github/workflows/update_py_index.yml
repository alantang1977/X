name: Update Python Files Index

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      input_folder:
        description: 'Pythonæ–‡ä»¶ç›®å½•'
        required: false
        default: './py'
        type: string
      output_file:
        description: 'è¾“å‡ºJSONæ–‡ä»¶'
        required: false
        default: './configs/plugins.json'
        type: string
  
  # æ¨é€è§¦å‘ï¼šå½“pyç›®å½•æˆ–è„šæœ¬å˜æ›´æ—¶
  push:
    paths:
      - 'py/**'
      - 'configs/generate_config.py'
      - '.github/workflows/update_py_index.yml'

jobs:
  generate-index:
    runs-on: ubuntu-latest  # ä½¿ç”¨Ubuntuè¿è¡Œå™¨
    
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
    
    # 2. è®¾ç½®Pythonç¯å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        # ä¸å†æ£€æŸ¥requirements.txt
    
    # 3. åˆ›å»ºç©ºçš„requirements.txtæ–‡ä»¶ï¼ˆè§£å†³Actionsé”™è¯¯ï¼‰
    - name: Create requirements.txt
      run: |
        # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ–‡ä»¶
        if [ ! -f requirements.txt ]; then
          echo "# ç©ºæ–‡ä»¶ï¼Œç”¨äºé¿å…GitHub Actionsé”™è¯¯" > requirements.txt
          echo "# å®é™…ä¾èµ–åœ¨generate_config.pyä¸­" >> requirements.txt
        fi
        cat requirements.txt
    
    # 4. è¿è¡Œç´¢å¼•ç”Ÿæˆè„šæœ¬
    - name: Generate JSON Index
      id: generate
      run: |
        echo "å¼€å§‹ç”ŸæˆPythonæ–‡ä»¶ç´¢å¼•..."
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        
        echo "æ£€æŸ¥pyç›®å½•:"
        if [ -d "py" ]; then
          ls -la py/
        else
          echo "pyç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
          mkdir -p py
          echo "print('ç¤ºä¾‹æ–‡ä»¶')" > py/ç¤ºä¾‹.py
        fi
        
        echo "è¿è¡Œç”Ÿæˆè„šæœ¬..."
        python configs/generate_config.py
        
        echo "ç”Ÿæˆçš„JSONæ–‡ä»¶:"
        if [ -f "configs/plugins.json" ]; then
          cat configs/plugins.json
        fi
    
    # 5. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
    - name: Check for changes
      id: check-changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        
        # é…ç½®Gitç”¨æˆ·
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥plugins.jsonæ˜¯å¦æœ‰å˜æ›´
        if [ -f "configs/plugins.json" ]; then
          # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
          git add configs/plugins.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
          if git diff --cached --quiet configs/plugins.json; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°é…ç½®å˜æ›´"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "å˜æ›´å†…å®¹:"
            git diff --cached configs/plugins.json | head -50
          fi
        else
          echo "plugins.jsonæ–‡ä»¶ä¸å­˜åœ¨"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
    
    # 6. æäº¤å¹¶æ¨é€å˜æ›´
    - name: Commit and Push
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        echo "æäº¤å¹¶æ¨é€å˜æ›´..."
        
        # åˆ›å»ºæäº¤
        commit_message="ğŸ¤– è‡ªåŠ¨æ›´æ–°: Pythonæ–‡ä»¶ç´¢å¼• [$(date +'%Y-%m-%d %H:%M:%S')]"
        git commit -m "$commit_message"
        
        # æ¨é€å˜æ›´
        git push origin HEAD:${{ github.ref }}
