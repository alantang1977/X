name: Update Python Files Index

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è¿è¡Œ
    - cron: '0 0 * * *'
  
  workflow_dispatch:
    inputs:
      input_folder:
        description: 'Pythonæ–‡ä»¶ç›®å½•è·¯å¾„'
        required: true
        default: './py'
      output_file:
        description: 'JSONè¾“å‡ºæ–‡ä»¶è·¯å¾„'
        required: true
        default: './configs/plugins.json'
      verbose:
        description: 'æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—'
        required: false
        default: 'false'
        type: boolean
  
  push:
    paths:
      - 'py/**'
      - 'configs/generate_config.py'
      - '.github/workflows/update_py_index.yml'

jobs:
  update-index:
    runs-on: ubuntu-latest  # æ”¹ä¸ºubuntu-latestï¼Œæ›´è½»é‡ä¸”æ”¯æŒPython
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Generate Python Files Index
      env:
        INPUT_FOLDER: ${{ github.event.inputs.input_folder || './py' }}
        OUTPUT_FILE: ${{ github.event.inputs.output_file || './configs/plugins.json' }}
        VERBOSE: ${{ github.event.inputs.verbose || 'false' }}
      run: |
        echo "ç”ŸæˆPythonæ–‡ä»¶ç´¢å¼•..."
        echo "è¾“å…¥ç›®å½•: $INPUT_FOLDER"
        echo "è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE"
        echo "è¯¦ç»†æ¨¡å¼: $VERBOSE"
        
        VERBOSE_FLAG=""
        if [ "$VERBOSE" = "true" ]; then
          VERBOSE_FLAG="-v"
        fi
        
        python configs/generate_config.py -i "$INPUT_FOLDER" -o "$OUTPUT_FILE" $VERBOSE_FLAG
    
    - name: Check for changes
      id: check-changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet configs/plugins.json; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°å˜æ›´"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          echo "å˜æ›´æ‘˜è¦:"
          git diff --stat configs/plugins.json
        fi
    
    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "æäº¤å¹¶æ¨é€å˜æ›´..."
        
        # æ·»åŠ å˜æ›´çš„æ–‡ä»¶
        git add configs/plugins.json
        
        # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–JSONæ–‡ä»¶å˜æ›´
        if git status --porcelain | grep -q "\.json$"; then
          git add *.json
        fi
        
        # åˆ›å»ºæäº¤
        COMMIT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
        COMMIT_MSG="ğŸ¤– Auto-update: Pythonæ–‡ä»¶ç´¢å¼• [$COMMIT_DATE]"
        
        git commit -m "$COMMIT_MSG"
        
        # æ¨é€å˜æ›´
        git push origin HEAD:${{ github.ref_name }}
    
    - name: Upload logs as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: generation-logs
        path: |
          configs/generate_config.log
          configs/plugins_*.json
        retention-days: 7
