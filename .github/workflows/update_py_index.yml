name: Update Python Files Index

on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è¿è¡Œä¸€æ¬¡[citation:3]
  schedule:
    - cron: '0 0 * * *'
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šåœ¨GitHubç½‘é¡µç‚¹å‡»è¿è¡Œ[citation:3]
  workflow_dispatch:
    inputs:
      input_folder:
        description: 'py'
        required: true
        default: './py'
      output_file:
        description: 'JSONé…ç½®è¾“å‡ºè·¯å¾„'
        required: true
        default: './configs/plugins.json'
  # 3. æ¨é€è§¦å‘ï¼šå½“pyç›®å½•æˆ–è„šæœ¬æœ‰å˜æ›´æ—¶è¿è¡Œ
  push:
    paths:
      - 'py/**'
      - 'scripts/**'
      - '.github/workflows/update_py_index.yml'

jobs:
  update-index:
    runs-on: windows-latest  # ä½¿ç”¨Windowsç¯å¢ƒä»¥ä¿æŒè·¯å¾„ä¸€è‡´æ€§[citation:1]
    
    steps:
    # 1. æ£€å‡ºä»“åº“ä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. è®¾ç½®Pythonç¯å¢ƒ (GitHubè¿è¡Œå™¨å·²é¢„è£…Python[citation:1])
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'  # ä½¿ç”¨é¢„è£…çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬[citation:1]
    
    # 3. è¿è¡Œç´¢å¼•ç”Ÿæˆè„šæœ¬
    - name: Generate Python Files Index
      env:
        # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥å‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
        INPUT_FOLDER: ${{ github.event_name == 'workflow_dispatch' && inputs.input_folder || './py' }}
        OUTPUT_FILE: ${{ github.event_name == 'workflow_dispatch' && inputs.output_file || './configs/plugins.json' }}
      run: |
        python scripts/generate_config.py
    
    # 4. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´ï¼Œè‹¥æœ‰åˆ™æäº¤
    - name: Check for changes and commit
      id: git-check
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add configs/  # æ·»åŠ configsç›®å½•ä¸‹çš„å˜æ›´
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„å˜æ›´
        if [ -n "$(git status --porcelain configs/)" ]; then
          git commit -m "ğŸ¤– Auto-update: æ›´æ–°Pythonæ–‡ä»¶ç´¢å¼• [$(date +'%Y-%m-%d %H:%M')]"
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "No changes detected."
          echo "changes=false" >> $GITHUB_OUTPUT
        fi
    
    # 5. æ¨é€å˜æ›´å›ä»“åº“
    - name: Push changes
      if: steps.git-check.outputs.changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref_name }}
