# emojis/replace_emojis.py

import os
import glob
import json
import re
import random
from typing import Any

# -----------------------------------------------------------------------------
# é…ç½®åŒºï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
# -----------------------------------------------------------------------------

# å¾…æ›¿æ¢çš„ Emoji å€™é€‰æ± ï¼ˆç¤ºä¾‹ä¸­åªåˆ—å‡ºéƒ¨åˆ†ï¼Œå®é™…è¯·å¡«å…¥ä½ çš„å®Œæ•´åˆ—è¡¨ï¼‰
EMOJI_POOL = [
    # é£Ÿç‰©å’Œé¥®æ–™ç›¸å…³Emoji (156ä¸ª)
    "ğŸ", "ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸ«",
    "ğŸˆ", "ğŸ’", "ğŸ‘", "ğŸ¥­", "ğŸ", "ğŸ¥¥", "ğŸ¥", "ğŸ…", "ğŸ«’", "ğŸ¥‘",
    "ğŸ†", "ğŸ¥”", "ğŸ¥•", "ğŸŒ½", "ğŸŒ¶ï¸", "ğŸ«‘", "ğŸ¥’", "ğŸ¥¬", "ğŸ¥¦", "ğŸ§„",
    "ğŸ§…", "ğŸ„", "ğŸ¥œ", "ğŸŒ°", "ğŸ", "ğŸ¥", "ğŸ¥–", "ğŸ«“", "ğŸ¥¨", "ğŸ¥¯",
    "ğŸ¥", "ğŸ§‡", "ğŸ§€", "ğŸ–", "ğŸ—", "ğŸ¥©", "ğŸ¥“", "ğŸ”", "ğŸŸ", "ğŸ•",
    "ğŸŒ®", "ğŸŒ¯", "ğŸ«”", "ğŸ¥™", "ğŸ§†", "ğŸ¥š", "ğŸ³", "ğŸ¥˜", "ğŸ²", "ğŸ«•",
    "ğŸ¥£", "ğŸ¥—", "ğŸ±", "ğŸ˜", "ğŸ™", "ğŸš", "ğŸ›", "ğŸœ", "ğŸ", "ğŸ ",
    "ğŸ¢", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¥®", "ğŸ¡", "ğŸ¥Ÿ", "ğŸ¥ ", "ğŸ¥¡", "ğŸ¦€",
    "ğŸ¦", "ğŸ¦", "ğŸ¦‘", "ğŸ¦", "ğŸ§", "ğŸ¨", "ğŸ¥§", "ğŸ°", "ğŸ‚", "ğŸ®",
    "ğŸ­", "ğŸ¬", "ğŸ«", "ğŸ¿", "ğŸ©", "ğŸª", "ğŸŒ°", "ğŸ¥œ", "ğŸ§‚", "ğŸ«˜",
    "ğŸ¯", "ğŸ§ˆ", "ğŸ¥›", "ğŸ¼", "â˜•", "ğŸ«–", "ğŸµ", "ğŸ¶", "ğŸ¾", "ğŸ·",
    "ğŸ¸", "ğŸ¹", "ğŸº", "ğŸ»", "ğŸ¥‚", "ğŸ¥ƒ", "ğŸ¥¤", "ğŸ§‹", "ğŸ§ƒ", "ğŸ§‰",
    "ğŸ§Š", "ğŸ¥¢", "ğŸ½ï¸", "ğŸ”ª", "ğŸ´", "ğŸ¥„", "ğŸ§‚", "ğŸ§‚", "ğŸ§‚", "ğŸ§‚",
    "ğŸš", "ğŸœ", "ğŸ", "ğŸŸ", "ğŸ”", "ğŸ•", "ğŸŒ®", "ğŸŒ¯", "ğŸ¥ª", "ğŸ¥™",
    "ğŸ³", "ğŸ˜", "ğŸ™", "ğŸ¢", "ğŸ¡", "ğŸ§", "ğŸ¨", "ğŸ¦", "ğŸ°", "ğŸ‚",
    "ğŸ¬", "ğŸ­", "ğŸ«", "ğŸ¿", "ğŸ©", "ğŸª", "ğŸŒ°", "ğŸ¥œ", "ğŸ§‚", "ğŸ«˜",
    "ğŸ¯", "ğŸ§ˆ", "ğŸ¥›", "ğŸ¼", "â˜•", "ğŸ«–", "ğŸµ", "ğŸ¶", "ğŸ¾", "ğŸ·",
    "ğŸ¸", "ğŸ¹", "ğŸº", "ğŸ»", "ğŸ¥‚", "ğŸ¥ƒ", "ğŸ¥¤", "ğŸ§‹", "ğŸ§ƒ", "ğŸ§‰",
    
    # åŠ¨ç‰©å’Œè‡ªç„¶ç›¸å…³Emoji (182ä¸ª)
    "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯",
    "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ”", "ğŸ§", "ğŸ¦", "ğŸ¤", "ğŸ£",
    "ğŸ¥", "ğŸ¦†", "ğŸ¦…", "ğŸ¦‰", "ğŸ¦‡", "ğŸº", "ğŸ—", "ğŸ´", "ğŸ¦„", "ğŸ",
    "ğŸ›", "ğŸ¦‹", "ğŸŒ", "ğŸ", "ğŸœ", "ğŸ•·ï¸", "ğŸ¦‚", "ğŸ¦Ÿ", "ğŸ¦—", "ğŸ¢",
    "ğŸ", "ğŸ¦", "ğŸ¦–", "ğŸ¦•", "ğŸ™", "ğŸ¦‘", "ğŸ¦", "ğŸ¦€", "ğŸ¡", "ğŸ ",
    "ğŸŸ", "ğŸ¬", "ğŸ³", "ğŸ‹", "ğŸ¦ˆ", "ğŸŠ", "ğŸ…", "ğŸ†", "ğŸ¦“", "ğŸ¦",
    "ğŸ¦§", "ğŸ¦£", "ğŸ˜", "ğŸ¦›", "ğŸ¦", "ğŸª", "ğŸ«", "ğŸ¦’", "ğŸ¦˜", "ğŸ¦¬",
    "ğŸƒ", "ğŸ‚", "ğŸ„", "ğŸ", "ğŸ–", "ğŸ", "ğŸ‘", "ğŸ", "ğŸ¦Œ", "ğŸ¦™",
    "ğŸ¦¥", "ğŸ¦˜", "ğŸ¦¨", "ğŸ¦¡", "ğŸ¦ƒ", "ğŸ•Šï¸", "ğŸ¦¢", "ğŸ¦š", "ğŸ¦œ", "ğŸ¦",
    "ğŸ•â€ğŸ¦º", "ğŸ¦®", "ğŸ•", "ğŸˆ", "ğŸˆâ€â¬›", "ğŸ¾", "ğŸŒ±", "ğŸŒ²", "ğŸŒ³", "ğŸŒ´",
    "ğŸŒµ", "ğŸŒ¾", "ğŸŒ¿", "ğŸ€", "ğŸ", "ğŸƒ", "ğŸ‚", "ğŸŒ¼", "ğŸŒ»", "ğŸŒ·",
    "ğŸŒ¹", "ğŸ¥€", "ğŸŒº", "ğŸŒ¸", "ğŸ’", "ğŸŒ±", "ğŸŒ¾", "ğŸŒ¿", "ğŸ€", "ğŸ",
    "ğŸƒ", "ğŸ‚", "ğŸŒ¼", "ğŸŒ»", "ğŸŒ·", "ğŸŒ¹", "ğŸ¥€", "ğŸŒº", "ğŸŒ¸", "ğŸ’",
    "ğŸŒ", "ğŸŒ", "ğŸŒ", "ğŸŒ•", "ğŸŒ–", "ğŸŒ—", "ğŸŒ˜", "ğŸŒ‘", "ğŸŒ’", "ğŸŒ“",
    "ğŸŒ”", "ğŸŒ™", "ğŸŒš", "ğŸŒ›", "ğŸŒœ", "ğŸŒŸ", "â­", "ğŸ’«", "ğŸŒ ", "â˜ï¸",
    "ğŸŒˆ", "ğŸŒ¤ï¸", "â›…", "ğŸŒ¥ï¸", "ğŸŒ¦ï¸", "ğŸŒ§ï¸", "â›ˆï¸", "ğŸŒ©ï¸", "ğŸŒ¨ï¸", "â„ï¸",
    "â˜ƒï¸", "â›„", "ğŸ’¨", "ğŸ’§", "ğŸ’¦", "ğŸŒŠ", "ğŸŒ«ï¸", "ğŸŒªï¸", "ğŸ”¥", "ğŸ—»",
    "ğŸ”ï¸", "ğŸŒ‹", "ğŸ—¾", "ğŸï¸", "ğŸœï¸", "ğŸŒ…", "ğŸŒ„", "ğŸŒ‡", "ğŸŒ†", "ğŸŒ‰",
    "ğŸŒŒ", "ğŸŒƒ", "ğŸŒ™", "ğŸŒš", "ğŸŒ›", "ğŸŒœ", "ğŸŒŸ", "â­", "ğŸ’«", "ğŸŒ ",
    "â˜ï¸", "ğŸŒˆ", "ğŸŒ¤ï¸", "â›…", "ğŸŒ¥ï¸", "ğŸŒ¦ï¸", "ğŸŒ§ï¸", "â›ˆï¸", "ğŸŒ©ï¸", "ğŸŒ¨ï¸",
    "â„ï¸", "â˜ƒï¸", "â›„", "ğŸ’¨", "ğŸ’§", "ğŸ’¦", "ğŸŒŠ", "ğŸŒ«ï¸", "ğŸŒªï¸", "ğŸ”¥",
    
    # æ—…è¡Œå’Œåœ°ç‚¹ç›¸å…³Emoji (211ä¸ª)
    "âœˆï¸", "ğŸ›«", "ğŸ›¬", "ğŸš", "ğŸš€", "ğŸ›¸", "ğŸš¢", "ğŸ›³ï¸", "â›´ï¸", "ğŸš‚",
    "ğŸš…", "ğŸš†", "ğŸšŠ", "ğŸš‰", "ğŸšŒ", "ğŸš", "ğŸš", "ğŸš", "ğŸš‘", "ğŸš’",
    "ğŸš“", "ğŸš”", "ğŸš•", "ğŸš–", "ğŸš—", "ğŸš˜", "ğŸš™", "ğŸšš", "ğŸš›", "ğŸšœ",
    "ğŸ›µ", "ğŸš²", "ğŸš", "â›½", "ğŸš§", "ğŸš¨", "ğŸš¥", "ğŸš¦", "ğŸ®", "ğŸ°",
    "ğŸ¯", "ğŸ­", "ğŸ¢", "ğŸ¬", "ğŸ¤", "ğŸ¥", "ğŸ¦", "ğŸ¨", "ğŸ©", "ğŸª",
    "ğŸ«", "ğŸ­", "ğŸ°", "ğŸ—¼", "ğŸ—½", "ğŸ—¿", "ğŸ—ºï¸", "ğŸ—¾", "ğŸï¸", "ğŸœï¸",
    "ğŸ•ï¸", "ğŸ–ï¸", "ğŸ”ï¸", "ğŸŒ‹", "ğŸ—»", "ğŸï¸", "ğŸŒ…", "ğŸŒ„", "ğŸŒ‡", "ğŸŒ†",
    "ğŸŒ‰", "ğŸŒŒ", "ğŸŒƒ", "ğŸ™ï¸", "ğŸŒƒ", "ğŸ™ï¸", "ğŸŒ†", "ğŸŒ‰", "ğŸŒ…", "ğŸŒ„",
    "ğŸŒ‡", "ğŸŒŒ", "ğŸ—ºï¸", "ğŸ—¾", "ğŸï¸", "ğŸœï¸", "ğŸ•ï¸", "ğŸ–ï¸", "ğŸ”ï¸", "ğŸŒ‹",
    "ğŸ—»", "ğŸï¸", "ğŸŒ…", "ğŸŒ„", "ğŸŒ‡", "ğŸŒ†", "ğŸŒ‰", "ğŸŒŒ", "ğŸŒƒ", "ğŸ™ï¸",
    "ğŸšª", "ğŸ›ï¸", "ğŸ›‹ï¸", "ğŸª‘", "ğŸªœ", "ğŸš½", "ğŸ›", "ğŸ›€", "ğŸš¿", "ğŸ§½",
    "ğŸ§´", "ğŸ§¼", "ğŸª¥", "ğŸª’", "ğŸª", "ğŸ›ï¸", "ğŸ›’", "ğŸ›ï¸", "ğŸ“º", "ğŸ“·",
    "ğŸ“¸", "ğŸ¥", "ğŸï¸", "ğŸ“½ï¸", "ğŸ’¿", "ğŸ’½", "ğŸ’¾", "ğŸ“€", "ğŸ–¥ï¸", "ğŸ’»",
    "ğŸ–¨ï¸", "ğŸ–±ï¸", "ğŸ–²ï¸", "ğŸ—„ï¸", "ğŸ“…", "ğŸ“†", "ğŸ“‡", "ğŸ“ˆ", "ğŸ“‰", "ğŸ“Š",
    "ğŸ“‹", "ğŸ“Œ", "ğŸ“", "ğŸ“", "ğŸ“", "ğŸ“", "âœ‚ï¸", "ğŸ–ï¸", "ğŸ–Šï¸", "ğŸ–‹ï¸",
    "âœ’ï¸", "ğŸ“", "ğŸ“„", "ğŸ“°", "ğŸ“‘", "ğŸ““", "ğŸ“”", "ğŸ“•", "ğŸ“–", "ğŸ“—",
    "ğŸ“˜", "ğŸ“™", "ğŸ“š", "ğŸ“›", "ğŸ”–", "ğŸ·ï¸", "ğŸ«", "ğŸŸï¸", "ğŸ«", "ğŸŸï¸",
    "ğŸ†", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸ…", "ğŸ–ï¸", "ğŸ—ï¸", "ğŸµï¸", "ğŸŒ¹", "ğŸŒº",
    "ğŸŒ¸", "ğŸ’", "ğŸŒ¼", "ğŸŒ»", "ğŸŒ·", "ğŸ¥€", "ğŸ", "ğŸ‚", "ğŸƒ", "ğŸ€",
    "ğŸŒ¿", "ğŸŒ¾", "ğŸŒµ", "ğŸŒ´", "ğŸŒ³", "ğŸŒ²", "ğŸŒ±", "ğŸ’«", "ğŸŒŸ", "â­",
    "ğŸŒ ", "ğŸŒŒ", "ğŸŒƒ", "ğŸŒ†", "ğŸŒ‡", "ğŸŒ„", "ğŸŒ…", "ğŸ™ï¸", "ğŸŒ‰", "ğŸ—¾",
    "ğŸï¸", "ğŸœï¸", "ğŸ•ï¸", "ğŸ–ï¸", "ğŸ”ï¸", "ğŸŒ‹", "ğŸ—»", "ğŸï¸", "ğŸ—ºï¸", "ğŸ—¿",
    "ğŸ—½", "ğŸ—¼", "ğŸ°", "ğŸ¯", "ğŸ¨", "ğŸ©", "ğŸ¬", "ğŸ¤", "ğŸ¥", "ğŸ¦",
    "ğŸª", "ğŸ«", "ğŸ­", "ğŸš‰", "ğŸšŠ", "ğŸš†", "ğŸš…", "ğŸš‚", "ğŸš¢", "ğŸ›³ï¸",
    "â›´ï¸", "ğŸš", "âœˆï¸", "ğŸ›«", "ğŸ›¬", "ğŸš€", "ğŸ›¸"
]

# ç²¾ç¡®åŒ¹é…å•ä¸ª Emoji çš„æ­£åˆ™ï¼ˆæ¶µç›–å¸¸ç”¨ Unicode Blockï¼‰
EMOJI_PATTERN = re.compile(
    r'['
    u'\U0001F300-\U0001F5FF'
    u'\U0001F600-\U0001F64F'
    u'\U0001F680-\U0001F6FF'
    u'\U0001F1E0-\U0001F1FF'
    u'\u2600-\u27BF'
    r']',
    flags=re.UNICODE
)

# è¾“å…¥ã€è¾“å‡ºç›®å½•
INPUT_DIR  = os.path.dirname(os.path.abspath(__file__))
OUTPUT_DIR = os.path.join(INPUT_DIR, "output")


# -----------------------------------------------------------------------------
# å·¥å…·å‡½æ•°
# -----------------------------------------------------------------------------

def collect_all_strings(obj: Any, collector: list):
    """
    é€’å½’éå† JSON ç»“æ„ï¼Œå°†æ‰€æœ‰å­—ç¬¦ä¸²å€¼åŠ å…¥ collector åˆ—è¡¨ã€‚
    """
    if isinstance(obj, dict):
        for v in obj.values():
            collect_all_strings(v, collector)
    elif isinstance(obj, list):
        for item in obj:
            collect_all_strings(item, collector)
    elif isinstance(obj, str):
        collector.append(obj)


def replace_in_string(s: str, replacements: dict) -> str:
    """
    åœ¨å•ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œä½¿ç”¨é¢„å…ˆå‡†å¤‡å¥½çš„ replacements æ˜ å°„è¡¨æ›¿æ¢æ‰€æœ‰ Emojiã€‚
    """
    def _sub(m):
        old = m.group(0)
        # æ¯æ¬¡åŒ¹é…å–å‡ºé˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ª new emoji
        return replacements.pop(0)
    return EMOJI_PATTERN.sub(_sub, s)


def traverse_and_replace(obj: Any, replacements: list) -> Any:
    """
    é€’å½’éå† JSONï¼Œé‡åˆ°å­—ç¬¦ä¸²å°±è°ƒç”¨ replace_in_stringï¼Œæ›¿æ¢é˜Ÿåˆ—ä¸­çš„ Emojiã€‚
    """
    if isinstance(obj, dict):
        return {k: traverse_and_replace(v, replacements) for k, v in obj.items()}
    elif isinstance(obj, list):
        return [traverse_and_replace(item, replacements) for item in obj]
    elif isinstance(obj, str):
        return replace_in_string(obj, replacements)
    else:
        return obj


# -----------------------------------------------------------------------------
# ä¸»å¤„ç†é€»è¾‘
# -----------------------------------------------------------------------------

def process_file(input_path: str, output_path: str):
    # 1. ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    os.makedirs(os.path.dirname(output_path), exist_ok=True)

    # 2. è¯»å–å¹¶è§£æ JSON
    with open(input_path, 'r', encoding='utf-8') as f:
        data = json.load(f)

    # 3. æ”¶é›†æ‰€æœ‰å­—ç¬¦ä¸²ï¼Œç»Ÿè®¡è¦æ›¿æ¢çš„ Emoji æ€»æ•°
    all_strings = []
    collect_all_strings(data, all_strings)

    emoji_count = 0
    for s in all_strings:
        emoji_count += len(EMOJI_PATTERN.findall(s))

    if emoji_count == 0:
        print(f"[è·³è¿‡] æ–‡ä»¶ {os.path.basename(input_path)} ä¸­æ—  Emojiã€‚")
        return

    # 4. ä»å€™é€‰æ± ä¸­éšæœºé€‰å– emoji_count ä¸ªä¸é‡å¤çš„ Emoji
    if emoji_count > len(EMOJI_POOL):
        raise ValueError(
            f"éœ€è¦æ›¿æ¢ {emoji_count} ä¸ª Emojiï¼Œä½†å€™é€‰æ± ä¸­åªæœ‰ {len(EMOJI_POOL)} ä¸ªï¼Œè¯·æ‰©å……å€™é€‰æ± ã€‚"
        )

    replacements = random.sample(EMOJI_POOL, k=emoji_count)
    # è½¬ä¸ºå¯ pop çš„é˜Ÿåˆ—
    replacements = list(replacements)

    # 5. é€’å½’æ›¿æ¢
    new_data = traverse_and_replace(data, replacements)

    # 6. å†™å› JSON
    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(new_data, f, ensure_ascii=False, indent=2)

    print(f"[å®Œæˆ] {os.path.basename(input_path)} â†’ {os.path.basename(output_path)} æ›¿æ¢äº† {emoji_count} ä¸ª Emoji")


def main():
    # æŸ¥æ‰¾æ‰€æœ‰ .json æ–‡ä»¶
    json_files = glob.glob(os.path.join(INPUT_DIR, "*.json"))
    if not json_files:
        print("åœ¨ç›®å½•ä¸­æœªæ‰¾åˆ°ä»»ä½• .json æ–‡ä»¶")
        return

    # å¤„ç†æ¯ä¸ªæ–‡ä»¶
    for path in json_files:
        filename = os.path.basename(path)
        out_path = os.path.join(OUTPUT_DIR, filename)
        process_file(path, out_path)

    print("æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆã€‚")


if __name__ == "__main__":
    main()
