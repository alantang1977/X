import os
import glob
import json
import re
import random
from typing import Any, List

# -----------------------------------------------------------------------------
# Emoji å€™é€‰æ± ï¼šè¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„å®Œæ•´åˆ—è¡¨ï¼Œå…±æ•°ç™¾ä¸ª
# -----------------------------------------------------------------------------
EMOJI_POOL: List[str] = [
    # æ ·ä¾‹ï¼šè¯·æ ¹æ®éœ€è¦å®Œæ•´å¡«å†™
    # é£Ÿç‰©å’Œé¥®æ–™ç›¸å…³Emoji (156ä¸ª)
    "ğŸ", "ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸ«",
    "ğŸˆ", "ğŸ’", "ğŸ‘", "ğŸ¥­", "ğŸ", "ğŸ¥¥", "ğŸ¥", "ğŸ…", "ğŸ«’", "ğŸ¥‘",
    "ğŸ†", "ğŸ¥”", "ğŸ¥•", "ğŸŒ½", "ğŸŒ¶ï¸", "ğŸ«‘", "ğŸ¥’", "ğŸ¥¬", "ğŸ¥¦", "ğŸ§„",
    "ğŸ§…", "ğŸ„", "ğŸ¥œ", "ğŸŒ°", "ğŸ", "ğŸ¥", "ğŸ¥–", "ğŸ«“", "ğŸ¥¨", "ğŸ¥¯",
    "ğŸ¥", "ğŸ§‡", "ğŸ§€", "ğŸ–", "ğŸ—", "ğŸ¥©", "ğŸ¥“", "ğŸ”", "ğŸŸ", "ğŸ•",
    "ğŸŒ®", "ğŸŒ¯", "ğŸ«”", "ğŸ¥™", "ğŸ§†", "ğŸ¥š", "ğŸ³", "ğŸ¥˜", "ğŸ²", "ğŸ«•",
    "ğŸ¥£", "ğŸ¥—", "ğŸ±", "ğŸ˜", "ğŸ™", "ğŸš", "ğŸ›", "ğŸœ", "ğŸ", "ğŸ ",
    "ğŸ¢", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¥®", "ğŸ¡", "ğŸ¥Ÿ", "ğŸ¥ ", "ğŸ¥¡", "ğŸ¦€",
    "ğŸ¦", "ğŸ¦", "ğŸ¦‘", "ğŸ¦", "ğŸ§", "ğŸ¨", "ğŸ¥§", "ğŸ°", "ğŸ‚", "ğŸ®",
    "ğŸ­", "ğŸ¬", "ğŸ«", "ğŸ¿", "ğŸ©", "ğŸª", "ğŸŒ°", "ğŸ¥œ", "ğŸ§‚", "ğŸ«˜",
    "ğŸ¯", "ğŸ§ˆ", "ğŸ¥›", "ğŸ¼", "â˜•", "ğŸ«–", "ğŸµ", "ğŸ¶", "ğŸ¾", "ğŸ·",
    "ğŸ¸", "ğŸ¹", "ğŸº", "ğŸ»", "ğŸ¥‚", "ğŸ¥ƒ", "ğŸ¥¤", "ğŸ§‹", "ğŸ§ƒ", "ğŸ§‰",
    "ğŸ§Š", "ğŸ¥¢", "ğŸ½ï¸", "ğŸ”ª", "ğŸ´", "ğŸ¥„", "ğŸ§‚", "ğŸ§‚", "ğŸ§‚", "ğŸ§‚",
    "ğŸš", "ğŸœ", "ğŸ", "ğŸŸ", "ğŸ”", "ğŸ•", "ğŸŒ®", "ğŸŒ¯", "ğŸ¥ª", "ğŸ¥™",
    "ğŸ³", "ğŸ˜", "ğŸ™", "ğŸ¢", "ğŸ¡", "ğŸ§", "ğŸ¨", "ğŸ¦", "ğŸ°", "ğŸ‚",
    "ğŸ¬", "ğŸ­", "ğŸ«", "ğŸ¿", "ğŸ©", "ğŸª", "ğŸŒ°", "ğŸ¥œ", "ğŸ§‚", "ğŸ«˜",
    "ğŸ¯", "ğŸ§ˆ", "ğŸ¥›", "ğŸ¼", "â˜•", "ğŸ«–", "ğŸµ", "ğŸ¶", "ğŸ¾", "ğŸ·",
    "ğŸ¸", "ğŸ¹", "ğŸº", "ğŸ»", "ğŸ¥‚", "ğŸ¥ƒ", "ğŸ¥¤", "ğŸ§‹", "ğŸ§ƒ", "ğŸ§‰",
    
    # åŠ¨ç‰©å’Œè‡ªç„¶ç›¸å…³Emoji (182ä¸ª)
    "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯",
    "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ”", "ğŸ§", "ğŸ¦", "ğŸ¤", "ğŸ£",
    "ğŸ¥", "ğŸ¦†", "ğŸ¦…", "ğŸ¦‰", "ğŸ¦‡", "ğŸº", "ğŸ—", "ğŸ´", "ğŸ¦„", "ğŸ",
    "ğŸ›", "ğŸ¦‹", "ğŸŒ", "ğŸ", "ğŸœ", "ğŸ•·ï¸", "ğŸ¦‚", "ğŸ¦Ÿ", "ğŸ¦—", "ğŸ¢",
    "ğŸ", "ğŸ¦", "ğŸ¦–", "ğŸ¦•", "ğŸ™", "ğŸ¦‘", "ğŸ¦", "ğŸ¦€", "ğŸ¡", "ğŸ ",
    "ğŸŸ", "ğŸ¬", "ğŸ³", "ğŸ‹", "ğŸ¦ˆ", "ğŸŠ", "ğŸ…", "ğŸ†", "ğŸ¦“", "ğŸ¦",
    "ğŸ¦§", "ğŸ¦£", "ğŸ˜", "ğŸ¦›", "ğŸ¦", "ğŸª", "ğŸ«", "ğŸ¦’", "ğŸ¦˜", "ğŸ¦¬",
    "ğŸƒ", "ğŸ‚", "ğŸ„", "ğŸ", "ğŸ–", "ğŸ", "ğŸ‘", "ğŸ", "ğŸ¦Œ", "ğŸ¦™",
    "ğŸ¦¥", "ğŸ¦˜", "ğŸ¦¨", "ğŸ¦¡", "ğŸ¦ƒ", "ğŸ•Šï¸", "ğŸ¦¢", "ğŸ¦š", "ğŸ¦œ", "ğŸ¦",
    "ğŸ•â€ğŸ¦º", "ğŸ¦®", "ğŸ•", "ğŸˆ", "ğŸˆâ€â¬›", "ğŸ¾", "ğŸŒ±", "ğŸŒ²", "ğŸŒ³", "ğŸŒ´",
    "ğŸŒµ", "ğŸŒ¾", "ğŸŒ¿", "ğŸ€", "ğŸ", "ğŸƒ", "ğŸ‚", "ğŸŒ¼", "ğŸŒ»", "ğŸŒ·",
    "ğŸŒ¹", "ğŸ¥€", "ğŸŒº", "ğŸŒ¸", "ğŸ’", "ğŸŒ±", "ğŸŒ¾", "ğŸŒ¿", "ğŸ€", "ğŸ",
    "ğŸƒ", "ğŸ‚", "ğŸŒ¼", "ğŸŒ»", "ğŸŒ·", "ğŸŒ¹", "ğŸ¥€", "ğŸŒº", "ğŸŒ¸", "ğŸ’",
    "ğŸŒ", "ğŸŒ", "ğŸŒ", "ğŸŒ•", "ğŸŒ–", "ğŸŒ—", "ğŸŒ˜", "ğŸŒ‘", "ğŸŒ’", "ğŸŒ“",
    "ğŸŒ”", "ğŸŒ™", "ğŸŒš", "ğŸŒ›", "ğŸŒœ", "ğŸŒŸ", "â­", "ğŸ’«", "ğŸŒ ", "â˜ï¸",
    "ğŸŒˆ", "ğŸŒ¤ï¸", "â›…", "ğŸŒ¥ï¸", "ğŸŒ¦ï¸", "ğŸŒ§ï¸", "â›ˆï¸", "ğŸŒ©ï¸", "ğŸŒ¨ï¸", "â„ï¸",
    "â˜ƒï¸", "â›„", "ğŸ’¨", "ğŸ’§", "ğŸ’¦", "ğŸŒŠ", "ğŸŒ«ï¸", "ğŸŒªï¸", "ğŸ”¥", "ğŸ—»",
    "ğŸ”ï¸", "ğŸŒ‹", "ğŸ—¾", "ğŸï¸", "ğŸœï¸", "ğŸŒ…", "ğŸŒ„", "ğŸŒ‡", "ğŸŒ†", "ğŸŒ‰",
    "ğŸŒŒ", "ğŸŒƒ", "ğŸŒ™", "ğŸŒš", "ğŸŒ›", "ğŸŒœ", "ğŸŒŸ", "â­", "ğŸ’«", "ğŸŒ ",
    "â˜ï¸", "ğŸŒˆ", "ğŸŒ¤ï¸", "â›…", "ğŸŒ¥ï¸", "ğŸŒ¦ï¸", "ğŸŒ§ï¸", "â›ˆï¸", "ğŸŒ©ï¸", "ğŸŒ¨ï¸",
    "â„ï¸", "â˜ƒï¸", "â›„", "ğŸ’¨", "ğŸ’§", "ğŸ’¦", "ğŸŒŠ", "ğŸŒ«ï¸", "ğŸŒªï¸", "ğŸ”¥",
    
    # æ—…è¡Œå’Œåœ°ç‚¹ç›¸å…³Emoji (211ä¸ª)
    "âœˆï¸", "ğŸ›«", "ğŸ›¬", "ğŸš", "ğŸš€", "ğŸ›¸", "ğŸš¢", "ğŸ›³ï¸", "â›´ï¸", "ğŸš‚",
    "ğŸš…", "ğŸš†", "ğŸšŠ", "ğŸš‰", "ğŸšŒ", "ğŸš", "ğŸš", "ğŸš", "ğŸš‘", "ğŸš’",
    "ğŸš“", "ğŸš”", "ğŸš•", "ğŸš–", "ğŸš—", "ğŸš˜", "ğŸš™", "ğŸšš", "ğŸš›", "ğŸšœ",
    "ğŸ›µ", "ğŸš²", "ğŸš", "â›½", "ğŸš§", "ğŸš¨", "ğŸš¥", "ğŸš¦", "ğŸ®", "ğŸ°",
    "ğŸ¯", "ğŸ­", "ğŸ¢", "ğŸ¬", "ğŸ¤", "ğŸ¥", "ğŸ¦", "ğŸ¨", "ğŸ©", "ğŸª",
    "ğŸ«", "ğŸ­", "ğŸ°", "ğŸ—¼", "ğŸ—½", "ğŸ—¿", "ğŸ—ºï¸", "ğŸ—¾", "ğŸï¸", "ğŸœï¸",
    "ğŸ•ï¸", "ğŸ–ï¸", "ğŸ”ï¸", "ğŸŒ‹", "ğŸ—»", "ğŸï¸", "ğŸŒ…", "ğŸŒ„", "ğŸŒ‡", "ğŸŒ†",
    "ğŸŒ‰", "ğŸŒŒ", "ğŸŒƒ", "ğŸ™ï¸", "ğŸŒƒ", "ğŸ™ï¸", "ğŸŒ†", "ğŸŒ‰", "ğŸŒ…", "ğŸŒ„",
    "ğŸŒ‡", "ğŸŒŒ", "ğŸ—ºï¸", "ğŸ—¾", "ğŸï¸", "ğŸœï¸", "ğŸ•ï¸", "ğŸ–ï¸", "ğŸ”ï¸", "ğŸŒ‹",
    "ğŸ—»", "ğŸï¸", "ğŸŒ…", "ğŸŒ„", "ğŸŒ‡", "ğŸŒ†", "ğŸŒ‰", "ğŸŒŒ", "ğŸŒƒ", "ğŸ™ï¸",
    "ğŸšª", "ğŸ›ï¸", "ğŸ›‹ï¸", "ğŸª‘", "ğŸªœ", "ğŸš½", "ğŸ›", "ğŸ›€", "ğŸš¿", "ğŸ§½",
    "ğŸ§´", "ğŸ§¼", "ğŸª¥", "ğŸª’", "ğŸª", "ğŸ›ï¸", "ğŸ›’", "ğŸ›ï¸", "ğŸ“º", "ğŸ“·",
    "ğŸ“¸", "ğŸ¥", "ğŸï¸", "ğŸ“½ï¸", "ğŸ’¿", "ğŸ’½", "ğŸ’¾", "ğŸ“€", "ğŸ–¥ï¸", "ğŸ’»",
    "ğŸ–¨ï¸", "ğŸ–±ï¸", "ğŸ–²ï¸", "ğŸ—„ï¸", "ğŸ“…", "ğŸ“†", "ğŸ“‡", "ğŸ“ˆ", "ğŸ“‰", "ğŸ“Š",
    "ğŸ“‹", "ğŸ“Œ", "ğŸ“", "ğŸ“", "ğŸ“", "ğŸ“", "âœ‚ï¸", "ğŸ–ï¸", "ğŸ–Šï¸", "ğŸ–‹ï¸",
    "âœ’ï¸", "ğŸ“", "ğŸ“„", "ğŸ“°", "ğŸ“‘", "ğŸ““", "ğŸ“”", "ğŸ“•", "ğŸ“–", "ğŸ“—",
    "ğŸ“˜", "ğŸ“™", "ğŸ“š", "ğŸ“›", "ğŸ”–", "ğŸ·ï¸", "ğŸ«", "ğŸŸï¸", "ğŸ«", "ğŸŸï¸",
    "ğŸ†", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸ…", "ğŸ–ï¸", "ğŸ—ï¸", "ğŸµï¸", "ğŸŒ¹", "ğŸŒº",
    "ğŸŒ¸", "ğŸ’", "ğŸŒ¼", "ğŸŒ»", "ğŸŒ·", "ğŸ¥€", "ğŸ", "ğŸ‚", "ğŸƒ", "ğŸ€",
    "ğŸŒ¿", "ğŸŒ¾", "ğŸŒµ", "ğŸŒ´", "ğŸŒ³", "ğŸŒ²", "ğŸŒ±", "ğŸ’«", "ğŸŒŸ", "â­",
    "ğŸŒ ", "ğŸŒŒ", "ğŸŒƒ", "ğŸŒ†", "ğŸŒ‡", "ğŸŒ„", "ğŸŒ…", "ğŸ™ï¸", "ğŸŒ‰", "ğŸ—¾",
    "ğŸï¸", "ğŸœï¸", "ğŸ•ï¸", "ğŸ–ï¸", "ğŸ”ï¸", "ğŸŒ‹", "ğŸ—»", "ğŸï¸", "ğŸ—ºï¸", "ğŸ—¿",
    "ğŸ—½", "ğŸ—¼", "ğŸ°", "ğŸ¯", "ğŸ¨", "ğŸ©", "ğŸ¬", "ğŸ¤", "ğŸ¥", "ğŸ¦",
    "ğŸª", "ğŸ«", "ğŸ­", "ğŸš‰", "ğŸšŠ", "ğŸš†", "ğŸš…", "ğŸš‚", "ğŸš¢", "ğŸ›³ï¸",
    "â›´ï¸", "ğŸš", "âœˆï¸", "ğŸ›«", "ğŸ›¬", "ğŸš€", "ğŸ›¸",
    # å¦‚éœ€æ›´å¤šè¯·è‡ªè¡Œæ‰©å……
]

# ç²¾ç¡®åŒ¹é…å•ä¸ª Emoji çš„æ­£åˆ™ï¼ˆUnicode å¸¸ç”¨å—ï¼‰
EMOJI_PATTERN = re.compile(
    r'('
    u'[\U0001F300-\U0001F5FF]'
    u'|[\U0001F600-\U0001F64F]'
    u'|[\U0001F680-\U0001F6FF]'
    u'|[\U0001F1E0-\U0001F1FF]'
    u'|[\u2600-\u27BF]'
    r')',
    flags=re.UNICODE
)

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
INPUT_DIR = BASE_DIR
OUTPUT_DIR = os.path.join(BASE_DIR, "output")


def find_emojis_in_head(text: str) -> List[str]:
    """
    æŸ¥æ‰¾æ–‡æœ¬ç¬¬ä¸€æ®µï¼ˆç¬¬ä¸€ä¸ª 'â”ƒ' å‰ï¼‰ä¸­çš„æ‰€æœ‰ Emojiã€‚
    """
    head = text.split('â”ƒ', 1)[0]
    return [m.group(0) for m in EMOJI_PATTERN.finditer(head)]


def collect_all_emojis(obj: Any, key: str = "name") -> List[str]:
    """
    é€’å½’æ”¶é›†æ‰€æœ‰ dict ä¸­ key="name" ç¬¬ä¸€æ®µçš„ Emojiï¼Œä¿æŒé¡ºåºã€‚
    """
    found = []
    if isinstance(obj, dict):
        for k, v in obj.items():
            if k == key and isinstance(v, str):
                found.extend(find_emojis_in_head(v))
            else:
                found.extend(collect_all_emojis(v, key))
    elif isinstance(obj, list):
        for item in obj:
            found.extend(collect_all_emojis(item, key))
    return found


def precise_replace_head_emojis(text: str, new_emojis: List[str]) -> str:
    """
    åªæ›¿æ¢æ–‡æœ¬ç¬¬ä¸€æ®µï¼ˆç¬¬ä¸€ä¸ª 'â”ƒ' å‰ï¼‰ä¸­çš„ Emojiï¼Œä¸”ä¸€ä¸€å¯¹åº”ã€ç²¾å‡†æ›¿æ¢ã€‚
    """
    head, *tail = text.split('â”ƒ', 1)
    matches = list(EMOJI_PATTERN.finditer(head))
    if len(matches) != len(new_emojis):
        raise ValueError("Emojiæ•°ç›®ä¸ä¸€è‡´ï¼Œæ— æ³•ç²¾å‡†æ›¿æ¢ã€‚")
    # æ›¿æ¢æ—¶å€’åºå¤„ç†ï¼Œé˜²æ­¢ä¸‹æ ‡åç§»
    head_list = list(head)
    for match, new_emoji in zip(reversed(matches), reversed(new_emojis)):
        start, end = match.span()
        head_list[start:end] = [new_emoji]
    new_head = ''.join(head_list)
    return new_head + ('â”ƒ' + tail[0] if tail else '')


def replace_name_head_emojis(obj: Any, new_emojis: List[str], key: str = "name"):
    """
    é€’å½’ç²¾å‡†æ›¿æ¢æ‰€æœ‰ dict ä¸­ key="name" ç¬¬ä¸€æ®µçš„ Emojiï¼Œä¿æŒ Emoji æ•°é‡ä¸å˜ï¼Œé¡ºåºä¸€è‡´ã€‚
    """
    if isinstance(obj, dict):
        for k, v in obj.items():
            if k == key and isinstance(v, str):
                old_count = len(find_emojis_in_head(v))
                this_new = [new_emojis.pop(0) for _ in range(old_count)]
                obj[k] = precise_replace_head_emojis(v, this_new)
            else:
                replace_name_head_emojis(v, new_emojis, key)
    elif isinstance(obj, list):
        for item in obj:
            replace_name_head_emojis(item, new_emojis, key)


def process_file(input_path: str, output_path: str):
    # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    os.makedirs(os.path.dirname(output_path), exist_ok=True)

    # 1. è¯»å– JSON
    try:
        with open(input_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
    except json.JSONDecodeError as e:
        print(f"[é”™è¯¯] æ— æ³•è§£æ JSON æ–‡ä»¶ {os.path.basename(input_path)}: {e}")
        return False

    # 2. æ”¶é›†æ‰€æœ‰éœ€è¦æ›¿æ¢çš„ emoji
    old_emojis = collect_all_emojis(data)
    total = len(old_emojis)
    if total == 0:
        print(f"[è·³è¿‡] `{os.path.basename(input_path)}` ä¸­ â€œnameâ€ å­—æ®µç¬¬ä¸€æ®µæ—  Emojiã€‚")
        return False

    # 3. æ£€æŸ¥ Emoji æ± æ˜¯å¦å……è¶³
    if total > len(set(EMOJI_POOL)):
        print(f"[é”™è¯¯] éœ€è¦æ›¿æ¢ {total} ä¸ª Emojiï¼Œä½†æ± ä¸­åªæœ‰ {len(set(EMOJI_POOL))} ä¸ªï¼Œè¯·è¡¥å…… EMOJI_POOLã€‚")
        return False

    # 4. éšæœºæŠ½å–ä¸é‡å¤çš„æ–° Emoji
    new_emojis = random.sample(list(set(EMOJI_POOL)), k=total)

    # 5. æ›¿æ¢
    data_copy = json.loads(json.dumps(data, ensure_ascii=False))  # æ·±æ‹·è´
    replace_name_head_emojis(data_copy, new_emojis.copy())

    # 6. å†™æ–‡ä»¶ï¼ˆå¦‚å†…å®¹æœ‰å˜åŒ–æ‰å†™ï¼‰
    orig_json = json.dumps(data, ensure_ascii=False, indent=2)
    new_json = json.dumps(data_copy, ensure_ascii=False, indent=2)
    if orig_json != new_json:
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(new_json)
        print(f"[å®Œæˆ] `{os.path.basename(input_path)}` â†’ `{os.path.basename(output_path)}`ï¼Œå·²ç²¾å‡†æ›¿æ¢ {total} ä¸ª Emoji")
        return True
    else:
        print(f"[æ— å˜åŒ–] `{os.path.basename(input_path)}` Emoji æ›¿æ¢åå†…å®¹æ— å˜åŒ–ã€‚")
        return False


def main():
    json_files = glob.glob(os.path.join(INPUT_DIR, "*.json"))
    if not json_files:
        print("âš ï¸ æœªæ‰¾åˆ°ä»»ä½• .json æ–‡ä»¶ã€‚")
        return

    changed_files = []
    for path in json_files:
        fname = os.path.basename(path)
        out = os.path.join(OUTPUT_DIR, fname)
        changed = process_file(path, out)
        if changed:
            changed_files.append(os.path.relpath(out))

    print("ğŸ‰ å…¨éƒ¨å¤„ç†å®Œæˆï¼Œè¾“å‡ºç›®å½•ï¼š", OUTPUT_DIR)
    # è¾“å‡ºå˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼Œä¾›GitHub Actionsè¯»å–
    if changed_files:
        with open(os.path.join(OUTPUT_DIR, ".changed_files.txt"), "w", encoding="utf-8") as f:
            for fn in changed_files:
                f.write(fn + "\n")


if __name__ == "__main__":
    main()
